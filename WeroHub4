local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "WeroHub Steal a Brainrot",
   LoadingTitle = "WeroHub Steal a Brainrot Script",
   LoadingSubtitle = "by WeroScripts",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Big Hub"
   },
   Discord = { Enabled = false },
   KeySystem = false,
})

local Tab = Window:CreateTab("Main")

-- Variables ESP
local espFolder = Instance.new("Folder")
espFolder.Name = "ESPFolder"
espFolder.Parent = player:WaitForChild("PlayerGui")
local ESPs = {}

-- Variables Tung Bat Auto Punch
local AUTO_PUNCH_ENABLED = false
local TUNG_BAT_NAME = "Tung Bat"

-- Función ESP
local function createESPForPlayer(targetPlayer)
    if targetPlayer == player then return end
    local character = targetPlayer.Character
    if not character then return end
    local head = character:FindFirstChild("Head")
    if not head then return end

    if ESPs[targetPlayer] then return end

    -- Highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = character
    highlight.FillColor = Color3.new(1, 0, 0)
    highlight.OutlineColor = Color3.new(1, 1, 1)
    highlight.Parent = espFolder

    -- BillboardGui con nombre
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPName"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 150, 0, 35)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = espFolder

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.TextStrokeTransparency = 0
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 20
    textLabel.Text = targetPlayer.Name
    textLabel.Parent = billboard

    ESPs[targetPlayer] = {
        Highlight = highlight,
        Billboard = billboard,
        TextLabel = textLabel
    }
end

local function removeESPForPlayer(targetPlayer)
    local esp = ESPs[targetPlayer]
    if esp then
        if esp.Highlight then esp.Highlight:Destroy() end
        if esp.Billboard then esp.Billboard:Destroy() end
        ESPs[targetPlayer] = nil
    end
end

local function updateESP()
    for targetPlayer, esp in pairs(ESPs) do
        local character = targetPlayer.Character
        if character and character.Parent then
            -- Forzar transparencia 0 para que no sean invisibles (bypass invisibilidad)
            for _, part in pairs(character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.LocalTransparencyModifier = 0
                end
            end
        else
            removeESPForPlayer(targetPlayer)
        end
    end
end

-- Conectar eventos ESP
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        wait(0.5)
        createESPForPlayer(plr)
    end)
end)

for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= player then
        if plr.Character then
            createESPForPlayer(plr)
        end
        plr.CharacterAdded:Connect(function()
            wait(0.5)
            createESPForPlayer(plr)
        end)
    end
end

-- Auto Tung Bat Punch
local function tryAutoPunch()
    if not AUTO_PUNCH_ENABLED then return end
    local character = player.Character
    if not character then return end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not hrp then return end

    -- Verificar si tienes Tung Bat equipado
    local tool = player.Character:FindFirstChildOfClass("Tool")
    if not tool or tool.Name ~= TUNG_BAT_NAME then return end

    for _, targetPlayer in pairs(Players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = targetPlayer.Character.HumanoidRootPart
            local distance = (hrp.Position - targetHRP.Position).Magnitude
            if distance <= 10 then
                -- Ejecutar golpe (trigger al evento de la tool)
                -- Esto depende de cómo esté programada la herramienta,
                -- usualmente es un RemoteEvent o función que se dispara al atacar
                -- Como ejemplo, vamos a activar la herramienta y "click" si tiene evento 'Activate'

                if tool:FindFirstChild("RemoteEvent") then
                    -- Algunos juegos usan RemoteEvent para golpes
                    tool.RemoteEvent:FireServer(targetPlayer)
                elseif tool:FindFirstChildWhichIsA("RemoteEvent") then
                    tool:FindFirstChildWhichIsA("RemoteEvent"):FireServer(targetPlayer)
                else
                    -- Como fallback, intentar activar la tool para hacer el golpe normal
                    tool:Activate()
                end
                -- Solo golpeamos a uno por frame para no saturar
                break
            end
        end
    end
end

RunService.Heartbeat:Connect(tryAutoPunch)
RunService.Heartbeat:Connect(updateESP)

-- Crear toggles en Rayfield

Tab:CreateToggle({
    Name = "ESP Players",
    CurrentValue = false,
    Flag = "ToggleESP",
    Callback = function(value)
        if value then
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= player and plr.Character then
                    createESPForPlayer(plr)
                end
            end
        else
            for plr, _ in pairs(ESPs) do
                removeESPForPlayer(plr)
            end
        end
    end,
})

Tab:CreateToggle({
    Name = "Auto Tung Bat Punch (10 studs)",
    CurrentValue = false,
    Flag = "ToggleAutoTungBat",
    Callback = function(value)
        AUTO_PUNCH_ENABLED = value
    end,
})
