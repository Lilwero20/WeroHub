local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local espFolder = Instance.new("Folder")
espFolder.Name = "ESPFolder"
espFolder.Parent = player:WaitForChild("PlayerGui")

-- Table para guardar ESPs creados
local ESPs = {}

local function createESPForPlayer(targetPlayer)
    if targetPlayer == player then return end
    local character = targetPlayer.Character
    if not character then return end
    local head = character:FindFirstChild("Head")
    if not head then return end

    -- Highlight (resaltar)
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = character
    highlight.FillColor = Color3.new(1, 0, 0) -- Rojo
    highlight.OutlineColor = Color3.new(1, 1, 1) -- Blanco
    highlight.Parent = espFolder

    -- BillboardGui para nombre
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPName"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 150, 0, 35)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = espFolder

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    textLabel.TextStrokeTransparency = 0
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 20
    textLabel.Text = targetPlayer.Name
    textLabel.Parent = billboard

    ESPs[targetPlayer] = {
        Highlight = highlight,
        Billboard = billboard,
        TextLabel = textLabel
    }
end

local function removeESPForPlayer(targetPlayer)
    local esp = ESPs[targetPlayer]
    if esp then
        if esp.Highlight then esp.Highlight:Destroy() end
        if esp.Billboard then esp.Billboard:Destroy() end
        ESPs[targetPlayer] = nil
    end
end

local function updateESP()
    for targetPlayer, esp in pairs(ESPs) do
        local character = targetPlayer.Character
        if character and character.Parent then
            -- Forzar transparencia 0 para que no sean invisibles (bypass invisibilidad)
            for _, part in pairs(character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.LocalTransparencyModifier = 0
                end
            end
        else
            removeESPForPlayer(targetPlayer)
        end
    end
end

-- Cuando un jugador se une
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        wait(0.5)
        createESPForPlayer(plr)
    end)
end)

-- Cuando un jugador ya est√° en el juego
for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= player then
        if plr.Character then
            createESPForPlayer(plr)
        end
        plr.CharacterAdded:Connect(function()
            wait(0.5)
            createESPForPlayer(plr)
        end)
    end
end

-- Loop para mantener la transparencia cero y actualizar el ESP
RunService.Heartbeat:Connect(function()
    updateESP()
end)
