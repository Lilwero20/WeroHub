local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "WeroHub Steal a Brainrot",
   LoadingTitle = "WeroHub Steal a Brainrot Script",
   LoadingSubtitle = "by WeroScripts",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Big Hub"
   },
   Discord = {
      Enabled = false,
   },
   KeySystem = false,
})

local Tab = Window:CreateTab("Main")

-- Variables generales
local originalWalkSpeed = 34
local boostedWalkSpeed = 60
local speedBypassConnection
local speedToggle = false
local spawnPos = hrp.Position
local savedPosition = nil
local autoTungBatToggle = false

-- ScreenGui y botones
local playerGui = player:WaitForChild("PlayerGui")
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BypassButtonsGui"
screenGui.Parent = playerGui

-- Botón Fly to Spawn
local flyButton = Instance.new("TextButton")
flyButton.Size = UDim2.new(0, 160, 0, 40)
flyButton.Position = UDim2.new(0.7, 0, 0.85, 0)
flyButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
flyButton.TextColor3 = Color3.new(1,1,1)
flyButton.Font = Enum.Font.GothamBold
flyButton.TextSize = 18
flyButton.Text = "Fly to Spawn"
flyButton.Visible = false
flyButton.Parent = screenGui

-- Botón Instant TP Up
local instantTPButton = flyButton:Clone()
instantTPButton.Position = UDim2.new(0.7, 0, 0.8, 0)
instantTPButton.Text = "Instant TP Up +50"
instantTPButton.Visible = false
instantTPButton.Parent = screenGui

-- Botón Guardar posición
local savePosButton = Instance.new("TextButton")
savePosButton.Size = UDim2.new(0, 160, 0, 40)
savePosButton.Position = UDim2.new(0.05, 0, 0.85, 0)
savePosButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
savePosButton.TextColor3 = Color3.new(1,1,1)
savePosButton.Font = Enum.Font.GothamBold
savePosButton.TextSize = 18
savePosButton.Text = "Guardar Posición"
savePosButton.Parent = screenGui

-- Botón Teletransportar a posición guardada
local tpSavedButton = savePosButton:Clone()
tpSavedButton.Position = UDim2.new(0.05, 0, 0.8, 0)
tpSavedButton.Text = "Teletransportar Guardado"
tpSavedButton.Parent = screenGui

-- Funciones principales

-- Speed bypass toggle
Tab:CreateToggle({
    Name = "Speed 60 Bypass",
    CurrentValue = false,
    Flag = "SpeedToggle",
    Callback = function(value)
        local char = player.Character or player.CharacterAdded:Wait()
        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hum then return end

        speedToggle = value

        if value then
            hum.WalkSpeed = boostedWalkSpeed
            speedBypassConnection = RunService.Heartbeat:Connect(function()
                pcall(function()
                    if hum and hum.WalkSpeed ~= boostedWalkSpeed then
                        hum.WalkSpeed = boostedWalkSpeed
                    end
                end)
            end)
        else
            if speedBypassConnection then
                speedBypassConnection:Disconnect()
                speedBypassConnection = nil
            end
            hum.WalkSpeed = originalWalkSpeed
        end
    end,
})

-- Mostrar/Ocultar botón Fly to Spawn
local flyButtonToggle = false
Tab:CreateToggle({
    Name = "Mostrar Botón Fly to Spawn",
    CurrentValue = false,
    Flag = "FlyButtonToggle",
    Callback = function(value)
        flyButtonToggle = value
        flyButton.Visible = flyButtonToggle
        if flyButtonToggle then
            spawnPos = hrp.Position -- Actualiza spawnPos
        end
    end,
})

-- Mostrar/Ocultar botón Instant TP Up
local instantTPButtonToggle = false
Tab:CreateToggle({
    Name = "Mostrar Botón Instant TP Up",
    CurrentValue = false,
    Flag = "InstantTPButtonToggle",
    Callback = function(value)
        instantTPButtonToggle = value
        instantTPButton.Visible = instantTPButtonToggle
    end,
})

-- Auto Tung Bat toggle
Tab:CreateToggle({
    Name = "Auto Tung Bat (10 studs)",
    CurrentValue = false,
    Flag = "AutoTungBatToggle",
    Callback = function(value)
        autoTungBatToggle = value
    end,
})

-- Anti ragdoll toggle
local antiRagdollConnection
Tab:CreateToggle({
    Name = "Anti Ragdoll",
    CurrentValue = false,
    Flag = "AntiRagdollToggle",
    Callback = function(value)
        if value then
            antiRagdollConnection = RunService.Heartbeat:Connect(function()
                local char = player.Character
                if char then
                    local hum = char:FindFirstChildOfClass("Humanoid")
                    if hum then
                        hum.PlatformStand = false
                    end
                end
            end)
        else
            if antiRagdollConnection then
                antiRagdollConnection:Disconnect()
                antiRagdollConnection = nil
            end
        end
    end,
})

-- Función vuelo gradual para Fly to Spawn
local function flyToPosition(targetPos)
    if not hrp or not hrp.Parent then return end
    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e5,1e5,1e5)
    bv.Velocity = Vector3.new(0,0,0)
    bv.Parent = hrp

    local flying = true
    local stage = 1 -- 1 = subir 10 studs, 2 = ir a spawn, 3 = bajar 10 studs

    RunService:BindToRenderStep("FlyBypass", 301, function()
        if not flying or not hrp or not hrp.Parent then
            flying = false
            RunService:UnbindFromRenderStep("FlyBypass")
            bv:Destroy()
            return
        end

        if stage == 1 then
            local target = hrp.Position + Vector3.new(0, 10, 0)
            local dir = (target - hrp.Position)
            if dir.Magnitude < 0.5 then
                stage = 2
            else
                bv.Velocity = dir.Unit * 34
            end
        elseif stage == 2 then
            local dir = (targetPos - hrp.Position)
            if dir.Magnitude < 1 then
                stage = 3
            else
                bv.Velocity = dir.Unit * 34
            end
        elseif stage == 3 then
            local target = hrp.Position - Vector3.new(0, 10, 0)
            local dir = (target - hrp.Position)
            if dir.Magnitude < 0.5 then
                flying = false
                RunService:UnbindFromRenderStep("FlyBypass")
                bv:Destroy()
                return
            else
                bv.Velocity = dir.Unit * 34
            end
        end
    end)
end

-- Función Instant TP Up (teletransporta instantáneamente +50 studs)
local function instantTPUp()
    if not hrp then return end
    local targetPos = hrp.Position + Vector3.new(0,50,0)
    hrp.CFrame = CFrame.new(targetPos)
end

-- Función simple teletransporte a posición guardada
local function simpleTeleport(targetPos)
    if hrp and targetPos then
        hrp.CFrame = CFrame.new(targetPos)
    end
end

-- Eventos botones
flyButton.MouseButton1Click:Connect(function()
    flyToPosition(spawnPos)
end)

instantTPButton.MouseButton1Click:Connect(function()
    instantTPUp()
end)

savePosButton.MouseButton1Click:Connect(function()
    savedPosition = hrp.Position
    print("Posición guardada:", savedPosition)
end)

tpSavedButton.MouseButton1Click:Connect(function()
    if savedPosition then
        simpleTeleport(savedPosition)
    else
        print("No hay posición guardada")
    end
end)

-- Auto Tung Bat function
RunService.Heartbeat:Connect(function()
    if autoTungBatToggle then
        local char = player.Character
        if not char then return end
        local tool = char:FindFirstChildOfClass("Tool")
        if tool and tool.Name == "Tung Bat" then
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChildOfClass("Humanoid") then
                    local dist = (plr.Character.HumanoidRootPart.Position - hrp.Position).Magnitude
                    if dist <= 10 then
                        -- Simular golpeando al jugador (esto depende de cómo funcione la herramienta, aquí un ejemplo simple)
                        tool:Activate() -- activa el tool, puede variar según herramienta
                        -- Podrías agregar eventos o disparar eventos remotos aquí para golpear si la herramienta usa RemoteEvents
                    end
                end
            end
        end
    end
end)

-- ESP básico (nombre + resaltado visible aunque invisibles)
local function createESP(plr)
    local espBillboard = Instance.new("BillboardGui")
    espBillboard.Name = "ESP"
    espBillboard.Adornee = plr.Character and plr.Character:FindFirstChild("Head")
    espBillboard.Size = UDim2.new(0,100,0,40)
    espBillboard.AlwaysOnTop = true

    local nameLabel = Instance.new("TextLabel")
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.new(1,0,0)
    nameLabel.TextStrokeColor3 = Color3.new(0,0,0)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.Text = plr.Name
    nameLabel.Size = UDim2.new(1,0,1,0)
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextScaled = true
    nameLabel.Parent = espBillboard

    espBillboard.Parent = plr.Character and plr.Character:FindFirstChild("Head")
    
    -- Resaltar cuerpo aunque esté invisible
    for _, part in pairs(plr.Character:GetChildren()) do
        if part:IsA("BasePart") then
            local highlight = part:FindFirstChild("ESPHighlight")
            if not highlight then
                highlight = Instance.new("Highlight")
                highlight.Name = "ESPHighlight"
                highlight.Adornee = part
                highlight.FillColor = Color3.fromRGB(255,0,0)
                highlight.OutlineColor = Color3.fromRGB(255,255,255)
                highlight.Parent = part
            end
        end
    end
end

local function removeESP(plr)
    if plr.Character then
        local head = plr.Character:FindFirstChild("Head")
        if head then
            local esp = head:FindFirstChild("ESP")
            if esp then
                esp:Destroy()
            end
        end
        for _, part in pairs(plr.Character:GetChildren()) do
            if part:IsA("BasePart") then
                local highlight = part:FindFirstChild("ESPHighlight")
                if highlight then
                    highlight:Destroy()
                end
            end
        end
    end
end

local function onCharacterAdded(plr, char)
    wait(0.1)
    createESP(plr)
end

for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= player and plr.Character then
        createESP(plr)
    end
    plr.CharacterAdded:Connect(function(char)
        onCharacterAdded(plr, char)
    end)
end

Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function(char)
        onCharacterAdded(plr, char)
    end)
end)

-- Mantener GUI y toggles después de morir
player.CharacterAdded:Connect(function(char)
    character = char
    hrp = char:WaitForChild("HumanoidRootPart")
    humanoid = char:WaitForChild("Humanoid")

    -- Reset speed toggle on respawn if was on
    if speedToggle then
        humanoid.WalkSpeed = boostedWalkSpeed
        speedBypassConnection = RunService.Heartbeat:Connect(function()
            pcall(function()
                if humanoid and humanoid.WalkSpeed ~= boostedWalkSpeed then
                    humanoid.WalkSpeed = boostedWalkSpeed
                end
            end)
        end)
    end

    -- Reactivar anti ragdoll si estaba activado
    if antiRagdollConnection then
        antiRagdollConnection:Disconnect()
        antiRagdollConnection = RunService.Heartbeat:Connect(function()
            if humanoid then
                humanoid.PlatformStand = false
            end
        end)
    end
end)
